name: iOS Branch Workflow
env:
  ENVIRONMENT_FILE: .env

on:
  workflow_call:
    inputs:
      working-directory:
        description: 'the directory to run each job of the workflow in'
        type: string
        default: '.'
      git-lfs:
        description: "Checkout the project with git lfs"
        type: boolean
        default: false
      workspace-path:
        description: "The path to the workspace file"
        type: string
        required: true
      test-scheme-name:
        description: "The name of the test scheme"
        type: string
        required: true
      test-simulator-device-name:
        description: "The device spec for the test"
        type: string
        required: true
      test-simulator-device-version:
        description: "The device version for the test"
        type: string
        required: true
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-branch
  cancel-in-progress: true

jobs:
  generate-build-number:
    runs-on: [self-hosted]
    outputs:
      build-number: ${{ steps.build-number-generator.outputs.build-number }}
    steps:
      - name: Generate Build Number
        id: build-number-generator
        run: |
          build_number=$(date +%s)
          echo "build-number=$build_number" >> $GITHUB_OUTPUT
          echo "Build Number: $build_number"
  lint:
    runs-on: [self-hosted, macOS]
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: QuickBirdEng/actions/checkout-ssh@main
        with:
          ssh-private-key: ${{ secrets.CI_SSH_PRIVATE_KEY_FOR_GITHUB_PRIVATE_REPOS }}
          git-lfs: ${{ inputs.git-lfs }}
      - uses: irgaly/setup-mint@v1
        with:
          mint-executable-directory: ./mint-bin
      - run: ./mint-bin/mint run xcodegen
      - run: ./mint-bin/mint run swiftlint swiftlint
  test:
    runs-on: [self-hosted, macOS]
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: QuickBirdEng/actions/checkout-ssh@main
        with:
          ssh-private-key: ${{ secrets.CI_SSH_PRIVATE_KEY_FOR_GITHUB_PRIVATE_REPOS }}
          git-lfs: ${{ inputs.git-lfs }}
      - uses: irgaly/setup-mint@v1
        with:
          mint-executable-directory: ./mint-bin
      - run: ./mint-bin/mint run xcodegen
      - uses: QuickBirdEng/actions/setup-fastlane-environment@update-ios-workflows
        with:
          apple-auth-key-id: ${{ secrets.APPLE_AUTH_KEY_ID }}
          apple-auth-key-issuer-id: ${{ secrets.APPLE_AUTH_KEY_ISSUER_ID }}
          apple-auth-key-content: ${{ secrets.APPLE_AUTH_KEY_CONTENT }}
          apple-auth-key-encoding: "base64"
          match-password: ${{ secrets.MATCH_PASSWORD }}
          match-repository: ${{ secrets.MATCH_REPO }}
          match-apple-id: ${{ secrets.APPLE_ID }}
          match-apple-team-id: ${{ secrets.APPLE_TEAM_ID }}
          match-keychain-password: ${{ secrets.FASTLANE_KEYCHAIN_PASSWORD }}
          build-number: ${{ needs.generate-build-number.outputs.build-number }}
          slack-slug: ${{ secrets.SLACK_SLUG }}
          working-directory: ${{ inputs.working-directory }}
      - uses: QuickBirdEng/actions/setup-fastlane@update-ios-workflows
        with:
          platform: ios
          working-directory: ${{ inputs.working-directory }}
      - name: Setup Gems
        shell: bash -l {0}
        working-directory: ${{ inputs.working-directory }}
        run: gem install bundler && bundle update
      - shell: bash -l {0}
        working-directory: ${{ inputs.working-directory }}
        run: bundle exec fastlane match_for_signing
      - run: xcodebuild test -workspace ${{ inputs.workspace-path }} -scheme ${{ inputs.test-scheme-name }} -destination 'platform=iOS Simulator,name=${{ inputs.test-simulator-device-name }},OS=${{ inputs.test-simulator-device-version }}' -enableCodeCoverage YES

      #- uses: QuickBirdEng/actions/setup-ios@main
      #- uses: QuickBirdEng/actions/setup-fastlane@main
        #with:
          #working-directory: ${{ inputs.working-directory }}
      #- shell: bash -l {0}
        #run: gem install bundler && bundle update
      #- name: Setup API Key (if secret is set)
        #shell: bash
        #run: |
          #if [[ '${{ secrets.RAW_API_KEY }}' != '' ]]; then
            #echo "API_KEY=${{ secrets.RAW_API_KEY }}" > Secrets.xcconfig
          #fi
      #- shell: bash -l {0}
        #env:
          #MATCH_REPO: ${{ secrets.MATCH_REPO }}
          #MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          #APPLE_AUTH_KEY_ID: ${{ secrets.APPLE_AUTH_KEY_ID }}
          #APPLE_AUTH_KEY_ISSUER_ID: ${{ secrets.APPLE_AUTH_KEY_ISSUER_ID }}
          #APPLE_AUTH_KEY_CONTENT: ${{ secrets.APPLE_AUTH_KEY_CONTENT }}
          #APPLE_AUTH_KEY_ENCODING: "base64"
        #run: fastlane lint
